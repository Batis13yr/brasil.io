{% extends 'base.html' %}
{% load l10n %}
{% load static %}
{% block title %}Covid19 por Município - Brasil.IO{% endblock %}

{% block head %}
{{ block.super }}
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.16/css/dataTables.material.min.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css" integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ==" crossorigin=""/>
<link rel="stylesheet" href="{% static 'css/covid19-map.css' %}"/>
<script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js" integrity="sha512-gZwIG9x3wUXg2hdXF6+rVkLF/0Vi9U8D2Ntg4Ga5I5BZpVkVxlJWbSQtXPSiUTtC0TjtGOmxa1AJPuV0CPthew==" crossorigin=""></script>
<script type="text/javascript" language="javascript" src="https://cdn.datatables.net/1.10.16/js/jquery.dataTables.min.js"></script>
<script type="text/javascript" language="javascript" src="{% static 'js/covid19-table.js' %}"></script>
<script type="text/javascript" language="javascript" src="{% static 'js/covid19-map.js' %}"></script>
{% endblock %}

{% block content %}{% localize on %}
<div>
  <h1> COVID19 no Brasil </h1>
  <p>
    O projeto Brasil.IO COVID19 é um esforço de mais de 35 voluntários,
    coletando diariamente dados dos boletins epidemiológicos das 27 Secretarias
    Estaduais de Saúde do país.
    <div class="center">
      <a class="btn"
        href="https://blog.brasil.io/2020/03/23/dados-coronavirus-por-municipio-mais-atualizados/">Saiba
        mais sobre o projeto</a>

      <a class="btn" href="{% url 'core:dataset-detail' 'covid19' %}">Acesse os dados
        completos</a>
      <a class="btn" href="{% url 'core:collaborate' %}">Colabore com o Brasil.IO</a>
    </div>
  </p>

  <div class="row">
    {% for row in aggregate %}
    <div class="col s2">
      <div class="card">
        <div class="card-content teal-text card-title">
          {{row.title}}
        </div>
        <div class="card-content card-body number">
          {{ row.value }} {% if row.value_percent %}({{ row.value_percent|floatformat:2 }}%){% endif %}
        </div>
      </div>
    </div>
    {% endfor %}
  </div>

  <h2> Municípios atingidos </h2>
  <div class="row">

    <div class="col m6 s12">
      <div id="map"></div>
      Nota: casos de municípios importados/indeterminados não estão
      representados no mapa.
    </div>

    <div class="col m6 s12">
      <p>
        <a class="btn" href="{% url 'core:dataset-table-detail' 'covid19' 'caso' %}&amp;?is_last=True&amp;place_type=city&amp;format=csv">
          Baixar dados em CSV
        </a>
      </p>
      <table class="table mdl-data-table" style="height: 600px">
        <thead>
          <tr>
            <th> Data de atualização </th>
            <th> Município </th>
            <th> UF </th>
            <th> Confirmados </th>
            <th> Confirmados por 100k hab. </th>
            <th> Mortes </th>
            <th> Mortalidade </th>
          </tr>
        </thead>

        <tbody>
          {% for row in city_data %}
          <tr>
            <td data-order="{% localize off %}{{ row.date_str }}{% endlocalize %}"> {{ row.date|date:"d/m/Y" }} </td>
            <td data-order="{{ row.city_str }}"> {{ row.city }} </td>
            <td> {{ row.state }} </td>
            <td data-order="{% localize off %}{{ row.confirmed }}{% endlocalize %}"> {{ row.confirmed }} </td>
            <td data-order="{% localize off %}{{ row.confirmed_per_100k_inhabitants }}{% endlocalize %}"> {{ row.confirmed_per_100k_inhabitants|floatformat:2 }} </td>
            <td data-order="{% localize off %}{{ row.deaths }}{% endlocalize %}"> {{ row.deaths }} </td>
            <td data-order="{% localize off %}{{ row.death_rate }}{% endlocalize %}"> {{ row.death_rate|floatformat:2 }}% </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- TODO: fix footer so we don't need this -->
    <p> <br> <br> <br> <br> <br> <br> <br> <br> </p>
  </div>
</div>
{% endlocalize %}
{% endblock %}

{% block script %}
{{ block.super }}
<script type="text/javascript">
// TODO: make AJAX requests to backend instead of writing these vars to template
var cityValues = {{ city_values_json|safe }};
var maxValues = {{ max_values_json|safe }};
</script>
{% endblock %}
